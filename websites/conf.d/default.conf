server {
    server_name     ~^((?<subdomain>.*)\.)?(?<domain>[^.]+)\.(?<tld>[^.]+)$;

    # Dynamically route requests to `<WEBSITES_PATH>/<VIRTUAL_HOST>/build/index.html`
    # The `/build` path is hardcoded because nginx.conf does not support .env variables
    # Example: the website should be found at `../www/domain.com/build/index.html`
    # Note: setting root inside location does not work
    root            /var/www/${subdomain}${domain}.${tld}/build/;

    location / {
        try_files $uri $uri.html $uri/ index.html;
    }

    # Serve GraphQL API
    # Make sure Docker Container name serving API matches 'domain' name and port
    location ~ ^/(gql|subscriptions)$ {
        proxy_pass http://${domain}:8080;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
    }
}
